<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Wildfire Multi-Metric Explorer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<style>
  html, body { height: 100%; margin: 0; padding: 0; font-family: Arial; }
  #map { width: 100%; height: 100%; }

  /* Year dropdown */
  #yearFilter {
    position: absolute;
    top: 20px;
    left: 70px;
    z-index: 99999;
    padding: 5px 10px;
    width: 130px;
    background: white;
    border: 2px solid #333;
    border-radius: 6px;
  }

  /* Left filter panel */
  #filterBar {
    position: absolute;
    top: 80px;
    left: 20px;
    width: 320px;
    background: white;
    padding: 15px;
    z-index: 9999;
    border-radius: 10px;
    box-shadow: 0 0 8px rgba(0,0,0,0.25);
  }

  .metric-block {
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 10px;
  }

  label { font-weight: bold; }
  .metric-title { font-weight: bold; margin-bottom: 5px; }

  input[type="range"] {
    width: 100%;
  }

  .legend {
    background: white;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 0 6px rgba(0,0,0,0.3);
    font-size: 12px;
  }
  .legend i {
    width: 16px;
    height: 16px;
    float: left;
    margin-right: 6px;
    opacity: 0.8;
  }
</style>

</head>

<body>

<!-- Year selector -->
<select id="yearFilter">
  <option value="all">All Years</option>
</select>

<!-- Left filter panel -->
<div id="filterBar">

  <label>Region</label>
  <select id="regionSelect">
    <option value="all">All regions</option>
  </select>

  <hr>

  <h3>Metric Filters</h3>
  <div id="metricContainer"></div>

</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* ===================================================
   1. Initialize map
=================================================== */
var map = L.map("map").setView([39.5, -98.35], 4);

var osm = L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  maxZoom: 18
}).addTo(map);

var riskLayer = L.geoJSON(null);
var fireLayer = L.geoJSON(null);


/* ===================================================
   2. Load datasets
=================================================== */
let allFireData = null;

fetch("risk_zones.geojson")
  .then(r => r.json())
  .then(data => riskLayer.addData(data));

fetch("fires_full.geojson")
  .then(r => r.json())
  .then(data => {
    allFireData = data;

    /* Extract years */
    data.features.forEach(f => {
      f.properties.year = String(f.properties.date).slice(0,4);
    });

    /* Fill year dropdown */
    let years = [...new Set(data.features.map(f => f.properties.year))].sort();
    const yearSel = document.getElementById("yearFilter");
    years.forEach(y => {
      let o=document.createElement("option");
      o.value = y;
      o.textContent = y;
      yearSel.appendChild(o);
    });

    /* Fill regions */
    let regions = [...new Set(data.features.map(f=>f.properties.region))].sort();
    const regSel = document.getElementById("regionSelect");
    regions.forEach(r=>{
      if(!r) return;
      let o=document.createElement("option");
      o.value = r;
      o.textContent = r;
      regSel.appendChild(o);
    });

    buildMetricFilters(data);
    applyFilters();
  });


/* ===================================================
   3. Define metric list (all except year)
=================================================== */
const metricList = {
  "tmmx_c": "Max Temperature (°C)",
  "tmnn_c": "Min Temperature (°C)",
  "vpd": "VPD",
  "sph": "Specific Humidity",
  "srad": "Solar Radiation",
  "fm100": "Fuel Moisture 100h",
  "fm1000": "Fuel Moisture 1000h",
  "latitude": "Latitude",
  "longitude": "Longitude",
  "month": "Month"
};


/* ===================================================
   4. Build dynamic sliders for each metric
=================================================== */
let metricRanges = {};       // store min/max
let metricEnabled = {};      // store checkbox
let metricMin = {};
let metricMax = {};

function buildMetricFilters(data) {
  const container = document.getElementById("metricContainer");

  Object.keys(metricList).forEach(metric => {
    let vals = data.features.map(f => parseFloat(f.properties[metric]));
    let min = Math.min(...vals);
    let max = Math.max(...vals);

    metricRanges[metric] = {min, max};
    metricEnabled[metric] = false;
    metricMin[metric] = min;
    metricMax[metric] = max;

    const block = document.createElement("div");
    block.className = "metric-block";

    block.innerHTML = `
      <label>
        <input type="checkbox" id="chk_${metric}">
        ${metricList[metric]}
      </label>
      <div id="txt_${metric}" style="font-size:13px; margin:4px 0;">
        ${min.toFixed(2)} – ${max.toFixed(2)}
      </div>

      <input type="range" id="min_${metric}" min="${min}" max="${max}" step="0.1" value="${min}">
      <input type="range" id="max_${metric}" min="${min}" max="${max}" step="0.1" value="${max}">
    `;
    container.appendChild(block);

    /* bind listeners */
    document.getElementById("chk_"+metric).addEventListener("change", e=>{
      metricEnabled[metric] = e.target.checked;
      applyFilters();
    });
    document.getElementById("min_"+metric).addEventListener("input", e=>{
      metricMin[metric] = parseFloat(e.target.value);
      document.getElementById("txt_"+metric).textContent =
        `${metricMin[metric].toFixed(2)} – ${metricMax[metric].toFixed(2)}`;
      applyFilters();
    });
    document.getElementById("max_"+metric).addEventListener("input", e=>{
      metricMax[metric] = parseFloat(e.target.value);
      document.getElementById("txt_"+metric).textContent =
        `${metricMin[metric].toFixed(2)} – ${metricMax[metric].toFixed(2)}`;
      applyFilters();
    });
  });
}


/* ===================================================
   5. Filtering logic
=================================================== */
function applyFilters() {
  if (!allFireData) return;

  const yr = document.getElementById("yearFilter").value;
  const region = document.getElementById("regionSelect").value;

  let filtered = {
    type: "FeatureCollection",
    features: allFireData.features.filter(f => {
      let p = f.properties;

      if (yr !== "all" && p.year !== yr) return false;
      if (region !== "all" && p.region !== region) return false;

      /* multi-metric filtering */
      for (let m of Object.keys(metricList)) {
        if (metricEnabled[m]) {
          let v = parseFloat(p[m]);
          if (v < metricMin[m] || v > metricMax[m]) return false;
        }
      }

      return true;
    })
  };

  fireLayer.clearLayers();
  fireLayer.addData(filtered);
}


/* ===================================================
   6. Event listeners
=================================================== */
document.getElementById("yearFilter").addEventListener("change", applyFilters);
document.getElementById("regionSelect").addEventListener("change", applyFilters);


/* ===================================================
   7. Layer control & legend
=================================================== */
L.control.layers(
  {"OpenStreetMap":osm},
  {"Risk Zones":riskLayer,"Fire Locations":fireLayer},
  {collapsed:false}
).addTo(map);

var legend = L.control({position:"bottomright"});
legend.onAdd = function(){
  let div=L.DomUtil.create("div","legend");
  div.innerHTML="<b>Risk Levels</b><br>";
  return div;
}
legend.addTo(map);

</script>

</body>
</html>
