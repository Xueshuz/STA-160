<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wildfire Explorer — States Filter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    html, body {
      margin: 0; padding: 0;
      height: 100%; font-family: Arial, sans-serif;
    }

    #map { width: 100%; height: 100%; }

    /* Year Dropdown */
    #yearFilter {
      position: absolute !important;
      top: 20px !important;
      left: 70px !important;
      width: 140px !important;
      z-index: 999999 !important;
      padding: 5px 10px !important;
      background: white !important;
      border: 2px solid #333 !important;
      border-radius: 6px !important;
      box-shadow: 0 0 4px rgba(0,0,0,0.3) !important;
    }

    /* 左侧过滤面板 */
    #filterBar {
      position: absolute; top: 80px; left: 20px;
      width: 280px; background: white;
      padding: 15px; z-index: 9999;
      border-radius: 8px;
      box-shadow:0 0 10px rgba(0,0,0,0.3);
    }

    label { font-weight: bold; display: block; margin-top: 10px; }
    select, input[type="range"], button {
      width: 100%; padding: 6px;
      margin-top: 6px; border-radius: 6px; border: 1px solid #aaa;
    }

    #rangeText { font-size: 13px; margin-top: 4px; }
    #resetBtn {
      margin-top: 10px; background:#0f7b88; color: #fff;
      border:none; cursor: pointer;
    }
    #resetBtn:hover { background:#0a5660; }

    #noDataMsg { display:none; color:#c00; font-size:12px; margin-top:6px; }

    #histogram { background:#fafafa; border:1px solid #ddd; border-radius:4px; }

    /* 隐藏 Loading 覆盖层 */
    #loadingOverlay { display:none !important; }

    /* Legend */
    .legend {
      background:white; padding:10px; border-radius:6px;
      box-shadow:0 0 6px rgba(0,0,0,0.3); font-size:12px;
    }
    .legend i {
      width:16px; height:16px; float:left; margin-right:6px; opacity:0.8;
    }
  </style>
</head>

<body>

<!-- 年份选择（去掉 All Years） -->
<select id="yearFilter"></select>

<!-- 左侧过滤栏 -->
<div id="filterBar">
  <label>Metric</label>
  <select id="metricSelect">
    <option value="tmmx_c">Max Temp (°C)</option>
    <option value="vpd">VPD</option>
  </select>

  <label>Region</label>
  <select id="regionSelect"></select>

  <label>State</label>
  <select id="stateSelect">
    <option value="all">All states</option>
  </select>

  <label>Value range</label>
  <div id="rangeText">–</div>
  <input type="range" id="minRange" step="0.1">
  <input type="range" id="maxRange" step="0.1">

  <div id="noDataMsg">No fires match the current filters.</div>

  <button id="resetBtn">Reset filters</button>

  <label style="margin-top:8px;">Distribution</label>
  <canvas id="histogram" width="240" height="80"></canvas>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<script>
/***********************************************************
  全局变量
***********************************************************/
let map, fireLayer, riskLayer, statesLayer;
let allFireData = null;
let statesGeo = null;
let stateLayerByName = {};

let currentMetric = "tmmx_c";
let currentYear = null;
let currentRegion = "all";
let currentState = "all";
let minVal = 0, maxVal = 100;

const histCanvas = document.getElementById("histogram");
const histCtx = histCanvas.getContext("2d");

/***********************************************************
  初始化地图
***********************************************************/
map = L.map("map").setView([39.5, -98.35], 4);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

/***********************************************************
  风险区
***********************************************************/
const riskColors = {
  "Very High":"#b10026",
  "High":"#fd8d3c",
  "Moderate":"#fecc5c",
  "Low":"#ffffb2"
};

riskLayer = L.geoJSON(null,{
  style:f=>({
    color:"#333", weight:0.5,
    fillColor:riskColors[f.properties.risk_level]||"#ccc",
    fillOpacity:0.6
  })
});

fetch("risk_zones.geojson")
  .then(r=>r.json())
  .then(j=>riskLayer.addData(j));

/***********************************************************
  Wildfire Layer
***********************************************************/
const fireIcon = L.icon({
  iconUrl:"https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
  iconSize:[25,41], iconAnchor:[12,41]
});

fireLayer = L.geoJSON(null,{
  pointToLayer:(f,latlng)=>L.marker(latlng,{icon:fireIcon})
});

/***********************************************************
  States Layer（不再加入 LayerControl）
***********************************************************/
statesLayer = L.geoJSON(null,{
  style:()=>({color:"#444",weight:1,fillOpacity:0}),
  onEachFeature:(feature,layer)=>{
    const name = feature.properties.name;
    stateLayerByName[name] = layer;

    layer.on("click",()=>{
      document.getElementById("stateSelect").value = name;
      currentState = name;
      highlightState(name);
      applyFilters();
    });
  }
});

fetch("https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json")
  .then(r=>r.json())
  .then(j=>{
    statesGeo = j;
    statesLayer.addTo(map);

    const sSel = document.getElementById("stateSelect");
    j.features.forEach(f=>{
      const o = document.createElement("option");
      o.value = f.properties.name;
      o.textContent = f.properties.name;
      sSel.appendChild(o);
    });
  });

function highlightState(name){
  statesLayer.resetStyle();
  if(name!=="all" && stateLayerByName[name])
    stateLayerByName[name].setStyle({fillOpacity:0.2,fillColor:"#3388ff"});
}

/***********************************************************
  加载 Wildfire 数据
***********************************************************/
fetch("fires_full.geojson")
  .then(r=>r.json())
  .then(data=>{
    allFireData = data;

    // 标准化 year，并修复 region（把 South → Mid East）
    allFireData.features.forEach(f=>{
      let p = f.properties;

      if(p.date) p.year = p.date.slice(0,4);
      p.year = String(p.year);

      if(p.region === "South") p.region = "Mid East";
    });

    /******** Year 下拉菜单（不再有 All Years） ********/
    const years = [...new Set(allFireData.features.map(f=>f.properties.year))]
                    .sort();
    const ySel = document.getElementById("yearFilter");
    years.forEach(y=>{
      const o=document.createElement("option");
      o.value=y; o.textContent=y;
      ySel.appendChild(o);
    });

    // 默认选第一个年份
    currentYear = years[0];
    ySel.value = currentYear;

    /******** Region 下拉菜单（自动读取，已替换 Mid East） ********/
    const regions = [...new Set(allFireData.features.map(f=>f.properties.region))]
                      .filter(Boolean).sort();

    const rSel = document.getElementById("regionSelect");
    rSel.innerHTML = "";

    regions.forEach(r=>{
      const o=document.createElement("option");
      o.value=r; o.textContent=r;
      rSel.appendChild(o);
    });

    // 默认 region = all
    const oAll = document.createElement("option");
    oAll.value = "all";
    oAll.textContent = "All regions";
    rSel.insertBefore(oAll, rSel.firstChild);

    initializeMetricRange();
    applyFilters();
  });

/***********************************************************
  Metric Range
***********************************************************/
function initializeMetricRange(){
  const metric = currentMetric;
  let v = allFireData.features
            .map(f=>parseFloat(f.properties[metric]))
            .filter(x=>!isNaN(x));

  minVal = Math.min(...v);
  maxVal = Math.max(...v);

  const minR = document.getElementById("minRange");
  const maxR = document.getElementById("maxRange");

  minR.min=minVal; minR.max=maxVal; minR.value=minVal;
  maxR.min=minVal; maxR.max=maxVal; maxR.value=maxVal;

  updateRangeLabel();
}

function updateRangeLabel(){
  const n = currentMetric==="tmmx_c" ? "Max Temp (°C)" : "VPD";
  document.getElementById("rangeText").textContent =
    `${n}: ${minVal.toFixed(1)} – ${maxVal.toFixed(1)}`;
}

/***********************************************************
  Filters
***********************************************************/
function applyFilters(){
  if(!allFireData) return;

  const filtered = {
    type:"FeatureCollection",
    features: allFireData.features.filter(f=>{
      const p = f.properties;

      if(p.year !== currentYear) return false;

      if(currentState!=="all"){
        const sf = statesGeo.features.find(x=>x.properties.name===currentState);
        if(sf){
          const pt = turf.point(f.geometry.coordinates);
          if(!turf.booleanPointInPolygon(pt,sf)) return false;
        }
      }

      if(currentState==="all" && currentRegion!=="all"){
        if(p.region !== currentRegion) return false;
      }

      const val = parseFloat(p[currentMetric]);
      if(val<minVal || val>maxVal) return false;

      return true;
    })
  };

  fireLayer.clearLayers();
  fireLayer.addData(filtered);

  autoZoom(filtered);
  updateHistogram(filtered);
}

function autoZoom(filtered){
  const pts = filtered.features.map(f=>{
    const c=f.geometry.coordinates;
    return [c[1],c[0]];
  });

  if(!pts.length){
    map.setView([39.5,-98.35],4);
    return;
  }

  const b = L.latLngBounds(pts);
  map.fitBounds(b.pad(0.2));
}

/***********************************************************
  Histogram
***********************************************************/
function updateHistogram(filtered){
  const vals = filtered.features
                .map(f=>parseFloat(f.properties[currentMetric]))
                .filter(x=>!isNaN(x));

  histCtx.clearRect(0,0,histCanvas.width,histCanvas.height);
  if(!vals.length) return;

  let minV=Math.min(...vals), maxV=Math.max(...vals);
  if(minV===maxV) maxV=minV+1;

  let bins=10, counts=Array(bins).fill(0);
  let step=(maxV-minV)/bins;

  vals.forEach(v=>{
    let i=Math.floor((v-minV)/step);
    if(i>=bins) i=bins-1;
    counts[i]++;
  });

  let w=histCanvas.width, h=histCanvas.height;
  let barW=w/bins, maxC=Math.max(...counts);

  histCtx.fillStyle="#0f7b88";
  counts.forEach((c,i)=>{
    let barH = maxC ? (c/maxC)*(h-10) : 0;
    histCtx.fillRect(i*barW+1, h-barH, barW-2, barH);
  });
}

/***********************************************************
  Event Listeners
***********************************************************/
document.getElementById("metricSelect").onchange=e=>{
  currentMetric=e.target.value;
  initializeMetricRange();
  applyFilters();
};

document.getElementById("yearFilter").onchange=e=>{
  currentYear=e.target.value;
  initializeMetricRange();
  applyFilters();
};

document.getElementById("regionSelect").onchange=e=>{
  currentRegion=e.target.value;
  applyFilters();
};

document.getElementById("stateSelect").onchange=e=>{
  currentState=e.target.value;
  highlightState(currentState);
  applyFilters();
};

document.getElementById("minRange").oninput=e=>{
  minVal=parseFloat(e.target.value);
  updateRangeLabel(); applyFilters();
};

document.getElementById("maxRange").oninput=e=>{
  maxVal=parseFloat(e.target.value);
  updateRangeLabel(); applyFilters();
};

document.getElementById("resetBtn").onclick=()=>{
  currentState="all";
  currentRegion="all";
  document.getElementById("stateSelect").value="all";
  document.getElementById("regionSelect").value="all";

  initializeMetricRange();
  applyFilters();
};

/***********************************************************
  Legend
***********************************************************/
L.control.layers({},{
  "Risk Zones": riskLayer,
  "Wildfires": fireLayer
},{collapsed:false}).addTo(map);

const legend = L.control({position:"bottomright"});
legend.onAdd=function(){
  const div=L.DomUtil.create("div","legend");
  div.innerHTML += "<b>Risk Levels</b><br>";
  for(const k in riskColors){
    div.innerHTML+=`<i style="background:${riskColors[k]};"></i> ${k}<br>`;
  }
  return div;
};
legend.addTo(map);
</script>

</body>
</html>

