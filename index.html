<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Leaflet CSS（无 integrity） -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* Year dropdown */
    #yearFilter {
      position: absolute;
      top: 70px;          /* 放在缩放按钮下面一点，更明显 */
      left: 10px;
      z-index: 9999;
      padding: 8px 12px;
      font-size: 14px;
      background: white;
      border: 2px solid #333;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
    }

    /* Legend */
    .legend {
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 12px;
      line-height: 18px;
    }
    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }
  </style>
</head>

<body>

<!-- Year Dropdown -->
<select id="yearFilter">
  <option value="all">All Years</option>
</select>

<!-- Map container -->
<div id="map"></div>

<!-- Leaflet JS（无 integrity） -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
<script>
// -------------------- 1. Initialize the map --------------------
var map = L.map("map").setView([39.5, -98.35], 4);

var osm = L.tileLayer(
  "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 18,
    attribution: "&copy; OpenStreetMap contributors"
  }
).addTo(map);

var topo = L.tileLayer(
  "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png",
  {
    maxZoom: 17,
    attribution: "&copy; OpenTopoMap"
  }
);

var baseLayers = {
  "OpenStreetMap": osm,
  "Topo Map": topo
};

// -------------------- 2. Risk Zone Colors --------------------
var riskColors = {
  "Very High": "#b10026",
  "High": "#fd8d3c",
  "Moderate": "#fecc5c",
  "Low": "#ffffb2"
};

function styleRisk(feature) {
  var lvl = feature.properties.risk_level;
  return {
    color: "#333",
    weight: 0.5,
    fillColor: riskColors[lvl] || "#cccccc",
    fillOpacity: 0.6
  };
}

var riskLayer = L.geoJSON(null, {
  style: styleRisk,
  onEachFeature: function (feature, layer) {
    var p = feature.properties;
    layer.bindPopup(
      "<b>Risk Level:</b> " + p.risk_level +
      "<br><b>Fire Days:</b> " + p.n_fire +
      "<br><b>Total Days:</b> " + p.n_obs +
      "<br><b>Fire Rate:</b> " + (p.risk_rate * 100).toFixed(1) + "%"
    );
  }
});

// Load risk zones
fetch("risk_zones.geojson")
  .then(r => r.json())
  .then(data => {
    riskLayer.addData(data);
  });

// -------------------- 3. Fire Points --------------------
var fireIcon = L.icon({
  iconUrl: "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
  iconSize: [25, 41],
  iconAnchor: [12, 41],
  popupAnchor: [1, -34]
});

var fireLayer = L.geoJSON(null, {
  pointToLayer: function (feature, latlng) {
    return L.marker(latlng, { icon: fireIcon });
  },
  onEachFeature: function (feature, layer) {
    var p = feature.properties;
    layer.bindPopup(
      "<b>Date:</b> " + p.date +
      "<br><b>Year:</b> " + p.year +
      "<br><b>Region:</b> " + p.region +
      "<br><b>Season:</b> " + p.season +
      "<br><b>Temp (°C):</b> " + p.tmmx_c +
      "<br><b>VPD:</b> " + p.vpd
    );
  }
});

var allFireData;

// Load fire points
fetch("fires_full.geojson")
  .then(r => r.json())
  .then(data => {

    // Add year field
    data.features.forEach(f => {
      var d = String(f.properties.date || "");
      f.properties.year = d.slice(0, 4);
    });

    allFireData = data;

    // Build year dropdown
    var years = [...new Set(data.features.map(f => f.properties.year).filter(Boolean))];
    years.sort();

    var dropdown = document.getElementById("yearFilter");
    years.forEach(y => {
      var opt = document.createElement("option");
      opt.value = y;
      opt.textContent = y;
      dropdown.appendChild(opt);
    });

    fireLayer.addData(data);
  });

// -------------------- 4. Year Filter --------------------
document.getElementById("yearFilter").addEventListener("change", function () {
  var selected = this.value;
  fireLayer.clearLayers();

  if (!allFireData) return;

  if (selected === "all") {
    fireLayer.addData(allFireData);
  } else {
    var filtered = {
      type: "FeatureCollection",
      features: allFireData.features.filter(
        f => f.properties.year === selected
      )
    };
    fireLayer.addData(filtered);
  }
});

// -------------------- 5. Layer Controls --------------------
var overlayLayers = {
  "Risk Zones": riskLayer,
  "Recent Fires": fireLayer
};

L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

// -------------------- 6. Legend --------------------
var legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  var div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<b>Risk Levels</b><br>";
  for (var k in riskColors) {
    div.innerHTML +=
      '<i style="background:' + riskColors[k] + ';"></i> ' + k + "<br>";
  }
  return div;
};

legend.addTo(map);
</script>
", function () {
  var selected = this.value;
  fireLayer.clearLayers();

  if (!allFireData) return;  // 数据还没加载完就点了的话，直接返回

  if (selected === "all") {
    fireLayer.addData(allFireData);
  } else {
    var filtered = {
      type: "FeatureCollection",
      features: allFireData.features.filter(
        f => String(f.properties.year) === String(selected)
      )
    };
    fireLayer.addData(filtered);
  }
});

// -------------------- 5. Layer Controls --------------------
var overlayLayers = {
  "Risk Zones": riskLayer,
  "Recent Fires": fireLayer
};

L.control.layers(baseLayers, overlayLayers, { collapsed: false }).addTo(map);

// -------------------- 6. Legend --------------------
var legend = L.control({ position: "bottomright" });

legend.onAdd = function () {
  var div = L.DomUtil.create("div", "legend");
  div.innerHTML += "<b>Risk Levels</b><br>";
  for (var k in riskColors) {
    div.innerHTML +=
      '<i style="background:' + riskColors[k] + ';"></i> ' + k + "<br>";
  }
  return div;
};

legend.addTo(map);
</script>

</body>
</html>
