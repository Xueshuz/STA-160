<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Wildfire Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-sA+4Jg1gj0KGFF2VHtLt6wHxZ34qkLJGeC2o9gXa1uU="
    crossorigin=""
  />

  <style>
    html, body, #map {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    .legend {
      background: white;
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      font-size: 12px;
      line-height: 18px;
    }

    .legend i {
      width: 16px;
      height: 16px;
      float: left;
      margin-right: 6px;
      opacity: 0.8;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j7kGStbG3o7mG8+EJ2N1n00p1r6tAEFwA6C4F6A="
  crossorigin="">
</script>

<script>

  // ---------- 1. 初始化地图 ----------
  var map = L.map('map').setView([39.5, -98.35], 4);

  var osm = L.tileLayer(
    'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
    {
      maxZoom: 18,
      attribution: '&copy; OpenStreetMap contributors'
    }
  ).addTo(map);

  var topo = L.tileLayer(
    'https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',
    {
      maxZoom: 17,
      attribution: '&copy; OpenTopoMap'
    }
  );

  var baseLayers = {
    "OpenStreetMap": osm,
    "Topo Map": topo
  };

  // ---------- 2. 风险区域颜色 ----------
  var riskColors = {
    "Very High": "#b10026",
    "High": "#fd8d3c",
    "Moderate": "#fecc5c",
    "Low": "#ffffb2"
  };

  function styleRisk(feature) {
    var lvl = feature.properties.risk_level;
    return {
      color: "#333",
      weight: 0.5,
      fillColor: riskColors[lvl] || "#cccccc",
      fillOpacity: 0.6
    };
  }

  // ---------- 3. 加载风险区域 ----------
  var riskLayer = L.geoJSON(null, {
    style: styleRisk,
    onEachFeature: function (feature, layer) {
      var p = feature.properties;
      layer.bindPopup(
        "<b>Risk Level:</b> " + p.risk_level +
        "<br><b>Fire Days:</b> " + p.n_fire +
        "<br><b>Total Days:</b> " + p.n_obs +
        "<br><b>Fire Rate:</b> " + (p.risk_rate * 100).toFixed(1) + "%"
      );
    }
  });

  fetch("risk_zones.geojson")
    .then(response => response.json())
    .then(data => riskLayer.addData(data));


  // ---------- 4. 最近火点 ----------
  var fireIcon = L.icon({
    iconUrl: "https://cdn-icons-png.flaticon.com/512/482/482988.png",
    iconSize: [24, 24],
    iconAnchor: [12, 12]
  });

  var fireLayer = L.geoJSON(null, {
    pointToLayer: function (feature, latlng) {
      return L.marker(latlng, {icon: fireIcon});
    },
    onEachFeature: function (feature, layer) {
      var p = feature.properties;
      layer.bindPopup(
        "<b>Date:</b> " + p.date +
        "<br><b>Region:</b> " + p.region +
        "<br><b>Season:</b> " + p.season +
        "<br><b>Temp (°C):</b> " + p.tmmx_c +
        "<br><b>VPD:</b> " + p.vpd
      );
    }
  });

  fetch("fires_recent.geojson")
    .then(response => response.json())
    .then(data => fireLayer.addData(data));


  // ---------- 5. 控制层 ----------
  var overlayLayers = {
    "Risk Zones": riskLayer,
    "Recent Fires": fireLayer
  };

  L.control.layers(baseLayers, overlayLayers, {collapsed: false}).addTo(map);


  // ---------- 6. 图例 ----------
  var legend = L.control({ position: "bottomright" });

  legend.onAdd = function () {
    var div = L.DomUtil.create("div", "legend");
    div.innerHTML += "<b>Risk Levels</b><br>";

    for (var k in riskColors) {
      div.innerHTML +=
        '<i style="background:' + riskColors[k] + ';"></i> ' + k + "<br>";
    }

    return div;
  };

  legend.addTo(map);

</script>
</body>
</html>
